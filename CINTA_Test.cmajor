/* Simple CINTA Test - Verify MIDI and Audio Work */

processor CINTA_Test [[ main ]]
{
    input event
    {
        std::notes::NoteOn noteOn;
        std::notes::NoteOff noteOff;
    }
    
    output stream float<2> audioOut;
    
    float phase = 0.0f;
    float frequency = 0.0f;
    float amplitude = 0.0f;
    
    event noteOn(std::notes::NoteOn e)
    {
        frequency = std::notes::noteToFrequency(e.pitch);
        amplitude = e.velocity;
        console <- "NOTE ON: pitch=" <- e.pitch <- " freq=" <- frequency <- " vel=" <- e.velocity;
    }
    
    event noteOff(std::notes::NoteOff e)
    {
        amplitude = 0.0f;
        console <- "NOTE OFF: pitch=" <- e.pitch;
    }
    
    void main()
    {
        let sampleRate = float(processor.frequency);
        
        loop
        {
            if (amplitude > 0.0f)
            {
                let phaseInc = frequency / sampleRate;
                let signal = float(sin(phase * twoPi)) * amplitude * 0.3f;
                
                phase += phaseInc;
                if (phase >= 1.0f) phase -= 1.0f;
                
                audioOut <- float<2>(signal, signal);
            }
            else
            {
                audioOut <- float<2>(0.0f, 0.0f);
            }
            
            advance();
        }
    }
}
