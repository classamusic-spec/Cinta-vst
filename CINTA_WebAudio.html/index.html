<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CINTA - Vintage Texture Machine</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles-vintage.css">
    <link rel="stylesheet" href="size-modes.css">
    <link rel="stylesheet" href="vintage-keyboard.css">
    <link rel="stylesheet" href="vintage-slider.css">
</head>
<body>
    <div id="cmaj-overlay">
        <div id="cmaj-info">
            <span style="font-size: 2rem; font-weight: bold;">CINTA</span>
            <span style="font-size: 1rem;">Vintage Texture Machine - 1975 Havana Studio Synth</span>
            <span id="cmaj-click-to-start" style="margin-top: 2rem; opacity: 0;">- Click to Start -</span>
        </div>
    </div>

    <div class="synth-container size-compact" id="synth-container" style="display: none;">
        
        <div class="header-controls">
            <button class="midi-selector-btn" id="midiSelectorBtn">
                <span>ðŸŽ¹ MIDI</span>
            </button>
            <div class="midi-dropdown" id="midiDropdown" style="display: none;">
                <div class="midi-device-list" id="midiDeviceList">
                    <div class="midi-device">No MIDI devices</div>
                </div>
            </div>
            
            <button class="size-toggle-btn" id="sizeToggleBtn">
                <span id="currentSizeLabel">COMPACT</span>
            </button>
            <div class="size-dropdown" id="sizeDropdown">
                <div class="size-option" data-size="full">
                    <span>FULL <span class="dimensions">(1400x700)</span></span>
                    <span class="shortcut">Ctrl+1</span>
                </div>
                <div class="size-option" data-size="compact">
                    <span>COMPACT <span class="dimensions">(900x600)</span></span>
                    <span class="shortcut">Ctrl+2</span>
                </div>
                <div class="size-option" data-size="mini">
                    <span>MINI <span class="dimensions">(500x340)</span></span>
                    <span class="shortcut">Ctrl+3</span>
                </div>
                <div class="size-option" data-size="strip">
                    <span>STRIP <span class="dimensions">(380x160)</span></span>
                    <span class="shortcut">Ctrl+4</span>
                </div>
            </div>
        </div>
        
        <div class="size-indicator" id="sizeIndicator"></div>
        
        <header class="header">
            <div class="logo">
                <div class="logo-badge">
                    <span class="logo-text">CINTA</span>
                    <span class="logo-subtitle">Vintage Texture Machine Â· Havana 1975</span>
                </div>
                <div class="logo-screws">
                    <div class="screw"></div>
                    <div class="screw"></div>
                    <div class="screw"></div>
                    <div class="screw"></div>
                </div>
            </div>
            
            <div class="preset-browser">
                <button class="preset-btn prev">â—€</button>
                <select id="preset-select">
                    <option>Init</option>
                    <optgroup label="Bells & Leads (13)">
                        <option>Reggaeton Bell</option>
                        <option>Bad Bunny Bell</option>
                        <option>Crystal Lead</option>
                        <option>Trap Bell</option>
                        <option>Lo-fi Lead</option>
                        <option>Bright Synth Lead</option>
                        <option>Ozuna Bell</option>
                        <option>Metallic Bell</option>
                        <option>Soft Bell</option>
                        <option>Vintage Lead</option>
                        <option>Icy Bell</option>
                        <option>Synth Stab</option>
                    </optgroup>
                    <optgroup label="Pads & Atmospheres (7)">
                        <option>Tainy Atmosphere</option>
                        <option>Tape Strings</option>
                        <option>Ethereal Pad</option>
                        <option>Warm Pad</option>
                        <option>Dark Pad</option>
                        <option>Ambient Wash</option>
                    </optgroup>
                    <optgroup label="Bass (3)">
                        <option>Analog Bass</option>
                        <option>Sub Bass</option>
                        <option>Trap 808</option>
                    </optgroup>
                    <optgroup label="Keys & Plucks (3)">
                        <option>Warm Rhodes</option>
                        <option>Pluck Synth</option>
                        <option>Marimba</option>
                    </optgroup>
                    <optgroup label="FX & Textures (2)">
                        <option>Radio Noise</option>
                        <option>Vinyl Crackle</option>
                    </optgroup>
                </select>
                <button class="preset-btn next">â–¶</button>
                <button class="preset-btn save">SAVE</button>
            </div>
            
            <div class="macro-knobs">
                <div class="macro-knob">
                    <div class="knob" data-param="vibe" data-min="0" data-max="1" data-value="0.3">
                        <div class="knob-pointer"></div>
                    </div>
                    <label>VIBE</label>
                </div>
                <div class="macro-knob">
                    <div class="knob" data-param="warmth" data-min="0" data-max="1" data-value="0.5">
                        <div class="knob-pointer"></div>
                    </div>
                    <label>WARMTH</label>
                </div>
                <div class="macro-knob">
                    <div class="knob" data-param="space" data-min="0" data-max="1" data-value="0.3">
                        <div class="knob-pointer"></div>
                    </div>
                    <label>SPACE</label>
                </div>
                <div class="macro-knob">
                    <div class="knob" data-param="movement" data-min="0" data-max="1" data-value="0.2">
                        <div class="knob-pointer"></div>
                    </div>
                    <label>MOVEMENT</label>
                </div>
                <div class="macro-knob">
                    <div class="knob" data-param="grit" data-min="0" data-max="1" data-value="0.1">
                        <div class="knob-pointer"></div>
                    </div>
                    <label>GRIT</label>
                </div>
            </div>
        </header>

        <div class="tape-deck" id="tape-deck">
            <div class="reel left-reel">
                <div class="reel-hub"></div>
                <div class="reel-spokes"></div>
                <div class="tape-level"></div>
            </div>
            <div class="tape-path">
                <div class="tape-guide"></div>
                <div class="tape-head"></div>
                <div class="tape-guide"></div>
            </div>
            <div class="reel right-reel">
                <div class="reel-hub"></div>
                <div class="reel-spokes"></div>
                <div class="tape-level"></div>
            </div>
        </div>

        <section class="engines-row">
            
            <div class="engine-panel" id="fm-engine">
                <div class="engine-header">
                    <h2>FM ENGINE</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="led-indicator on"></div>
                        <button class="toggle-btn active" data-param="fm_on">ON</button>
                    </div>
                </div>
                <div class="engine-controls" id="fm-sliders"></div>
            </div>

            <div class="engine-panel" id="tape-engine">
                <div class="engine-header">
                    <h2>TAPE ENGINE</h2>
                    <select class="sound-select" data-param="tape_sound" style="margin: 0 auto;">
                        <option value="0">Strings</option>
                        <option value="1">Flutes</option>
                        <option value="2">Choirs</option>
                        <option value="3">Brass</option>
                        <option value="4">Keys</option>
                    </select>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="led-indicator"></div>
                        <button class="toggle-btn" data-param="tape_on">OFF</button>
                    </div>
                </div>
                <div class="engine-controls" id="tape-sliders"></div>
            </div>

            <div class="engine-panel" id="analog-engine">
                <div class="engine-header">
                    <h2>ANALOG ENGINE</h2>
                    <select class="sound-select" data-param="analog_osc1_wave" style="margin: 0 auto;">
                        <option value="0">Saw</option>
                        <option value="1">Square</option>
                        <option value="2">Pulse</option>
                        <option value="3">Triangle</option>
                    </select>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="led-indicator"></div>
                        <button class="toggle-btn" data-param="analog_on">OFF</button>
                    </div>
                </div>
                <div class="engine-controls" id="analog-sliders"></div>
            </div>
        </section>

        <section class="texture-rack">
            <h2>TEXTURE RACK</h2>
            <div class="texture-slots">
                
                <div class="texture-slot">
                    <div class="led-indicator"></div>
                    <button class="toggle-btn small" data-param="tape_age" style="display:none;">OFF</button>
                    <span class="texture-name">TAPE AGE</span>
                    <div class="knob small" data-param="tape_age" data-min="0" data-max="1" data-value="0.3">
                        <div class="knob-pointer"></div>
                    </div>
                </div>
                
                <div class="texture-slot">
                    <div class="led-indicator"></div>
                    <button class="toggle-btn small" data-param="vinyl_amount" style="display:none;">OFF</button>
                    <span class="texture-name">VINYL</span>
                    <div class="knob small" data-param="vinyl_amount" data-min="0" data-max="1" data-value="0.3">
                        <div class="knob-pointer"></div>
                    </div>
                </div>
                
                <div class="texture-slot">
                    <div class="led-indicator"></div>
                    <button class="toggle-btn small" data-param="tube_drive" style="display:none;">OFF</button>
                    <span class="texture-name">TUBE</span>
                    <div class="knob small" data-param="tube_drive" data-min="0" data-max="1" data-value="0.3">
                        <div class="knob-pointer"></div>
                    </div>
                </div>
                
                <div class="texture-slot">
                    <div class="led-indicator"></div>
                    <button class="toggle-btn small" data-param="room_size" style="display:none;">OFF</button>
                    <span class="texture-name">ROOM</span>
                    <div class="knob small" data-param="room_size" data-min="0" data-max="1" data-value="0.3">
                        <div class="knob-pointer"></div>
                    </div>
                </div>
                
                <div class="texture-slot">
                    <div class="led-indicator"></div>
                    <button class="toggle-btn small" data-param="crush_bits" style="display:none;">OFF</button>
                    <span class="texture-name">CRUSH</span>
                    <div class="knob small" data-param="crush_bits" data-min="4" data-max="16" data-value="12">
                        <div class="knob-pointer"></div>
                    </div>
                </div>
                
            </div>
        </section>

        <section class="arp-machine">
            <div class="arp-header">
                <h2>ðŸŽ¹ ARP MACHINE</h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <div class="led-indicator"></div>
                    <button class="toggle-btn" data-param="arp_on">OFF</button>
                </div>
            </div>
            
            <div class="arp-selectors">
                <div class="selector-group">
                    <label>MELODY</label>
                    <select data-param="arp_pattern">
                        <option value="0">DÃ¡kiti Style</option>
                        <option value="1">CallaÃ­ta Style</option>
                        <option value="2">Tusa Style</option>
                        <option value="3">Yonaguni Style</option>
                        <option value="4">Moscow Mule</option>
                        <option value="5">Me Porto Bonito</option>
                        <option value="6">Dark Bell</option>
                        <option value="7">Flute Trap</option>
                        <option value="8">Summer Hit</option>
                        <option value="9">Radio Ready</option>
                    </select>
                </div>
                
                <div class="selector-group">
                    <label>RHYTHM</label>
                    <select data-param="arp_pattern">
                        <option value="0">Classic Dembow</option>
                        <option value="1">Modern Dembow</option>
                        <option value="2">Half-Time Dembow</option>
                        <option value="3">Perreo Intenso</option>
                        <option value="4">Perreo Suave</option>
                        <option value="5">808 Bounce</option>
                        <option value="6">Hi-Hat Rolls</option>
                        <option value="7">Trap Latino</option>
                        <option value="8">Tresillo</option>
                        <option value="9">Clave</option>
                    </select>
                </div>
                
                <div class="selector-group">
                    <label>SCALE</label>
                    <select data-param="arp_pattern">
                        <option value="0">Reggaeton Minor</option>
                        <option value="1">Reggaeton Major</option>
                        <option value="2">Trap Minor</option>
                        <option value="3">Latin Pop</option>
                        <option value="4">Sad Boy</option>
                        <option value="5">Perreo</option>
                        <option value="6">Romantic</option>
                        <option value="7">Callejero</option>
                    </select>
                </div>
                
                <div class="selector-group key-selector">
                    <label>KEY</label>
                    <div class="key-buttons">
                        <button class="key-btn active" data-key="0">C</button>
                        <button class="key-btn" data-key="1">C#</button>
                        <button class="key-btn" data-key="2">D</button>
                        <button class="key-btn" data-key="3">D#</button>
                        <button class="key-btn" data-key="4">E</button>
                        <button class="key-btn" data-key="5">F</button>
                        <button class="key-btn" data-key="6">F#</button>
                        <button class="key-btn" data-key="7">G</button>
                        <button class="key-btn" data-key="8">G#</button>
                        <button class="key-btn" data-key="9">A</button>
                        <button class="key-btn" data-key="10">A#</button>
                        <button class="key-btn" data-key="11">B</button>
                    </div>
                </div>
            </div>
            
            <div class="arp-pattern-display">
                <div class="pattern-step"></div>
                <div class="pattern-step active"></div>
                <div class="pattern-step"></div>
                <div class="pattern-step active"></div>
                <div class="pattern-step"></div>
                <div class="pattern-step"></div>
                <div class="pattern-step active"></div>
                <div class="pattern-step"></div>
                <div class="pattern-step active"></div>
                <div class="pattern-step"></div>
                <div class="pattern-step active"></div>
                <div class="pattern-step"></div>
                <div class="pattern-step"></div>
                <div class="pattern-step active"></div>
                <div class="pattern-step"></div>
                <div class="pattern-step"></div>
            </div>
            
            <div class="arp-controls">
                <button class="randomize-btn" id="randomize">ðŸŽ² RANDOMIZE</button>
                
                <div class="selector-group">
                    <label>MODE</label>
                    <select data-param="arp_pattern">
                        <option value="0">HITMAKER</option>
                        <option value="1">VIBRAS</option>
                        <option value="2">EMOCIONES</option>
                        <option value="3">ALTURA</option>
                        <option value="4">PERREO</option>
                        <option value="5">EXPERIMENTAL</option>
                    </select>
                </div>
                
                <div class="knob-group">
                    <div class="knob small" data-param="arp_rate" data-min="0" data-max="8" data-value="3">
                        <div class="knob-pointer"></div>
                    </div>
                    <label>Rate</label>
                </div>
                
                <div class="knob-group">
                    <div class="knob small" data-param="arp_swing" data-min="0" data-max="100" data-value="0">
                        <div class="knob-pointer"></div>
                    </div>
                    <label>Swing</label>
                </div>
                
                <div class="knob-group">
                    <div class="knob small" data-param="arp_gate" data-min="1" data-max="100" data-value="75">
                        <div class="knob-pointer"></div>
                    </div>
                    <label>Gate</label>
                </div>
                
                <div class="knob-group">
                    <div class="knob small" data-param="arp_octaves" data-min="1" data-max="4" data-value="2">
                        <div class="knob-pointer"></div>
                    </div>
                    <label>Octaves</label>
                </div>
            </div>
            
            <div class="arp-variations">
                <button class="var-btn" data-variation="octave-up">â†‘ OCT</button>
                <button class="var-btn" data-variation="octave-down">â†“ OCT</button>
                <button class="var-btn" data-variation="invert">INVERT</button>
                <button class="var-btn" data-variation="reverse">REVERSE</button>
                <button class="var-btn" data-variation="simplify">SIMPLE</button>
                <button class="var-btn" data-variation="double">DOUBLE</button>
                <button class="var-btn" data-variation="shift-left">â—„â—„</button>
                <button class="var-btn" data-variation="shift-right">â–ºâ–º</button>
            </div>
        </section>

        <section class="bottom-controls">
            <div class="envelope-section">
                <h3>ENVELOPE</h3>
                <div class="env-sliders" id="envelope-sliders"></div>
            </div>
            
            <div class="master-section">
                <h3>MASTER OUTPUT</h3>
                
                <div class="vu-meter" id="vu-meter" data-level="low">
                    <div class="vu-face">
                        <div class="vu-scale">
                            <span class="vu-mark" style="--angle: -45deg">-20</span>
                            <span class="vu-mark" style="--angle: -30deg">-10</span>
                            <span class="vu-mark" style="--angle: -15deg">-7</span>
                            <span class="vu-mark" style="--angle: 0deg">-5</span>
                            <span class="vu-mark" style="--angle: 15deg">-3</span>
                            <span class="vu-mark" style="--angle: 30deg">0</span>
                            <span class="vu-mark red" style="--angle: 40deg">+1</span>
                            <span class="vu-mark red" style="--angle: 50deg">+3</span>
                        </div>
                        <div class="vu-needle"></div>
                        <div class="vu-pivot"></div>
                    </div>
                    <div class="vu-glass"></div>
                    <div class="vu-label">VU</div>
                </div>
                
                <div class="master-slider" id="master-slider"></div>
            </div>
        </section>
        
        <div id="cmaj-main" class="main-content"></div>
        <button class="keyboard-toggle-btn" id="keyboardToggleBtn">
            <span>ðŸŽ¹ PIANO</span>
            <span class="icon">â–¼</span>
        </button>
        <div id="cmaj-keyboard-container"></div>
        
    </div>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            min-height: 100vh;
            background: #1a1410;
        }
        
        .header-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .midi-selector-btn {
            background: linear-gradient(135deg, #6b5644 0%, #5a4a3a 100%);
            border: 2px solid #5a4a3a;
            border-radius: 6px;
            padding: 8px 16px;
            color: #f5f0e6;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1);
            transition: all 0.2s ease;
        }
        
        .midi-selector-btn:hover {
            background: linear-gradient(135deg, #7b6654 0%, #6a5a4a 100%);
            transform: translateY(-1px);
        }
        
        .midi-dropdown {
            position: absolute;
            top: 100%;
            right: 120px;
            margin-top: 8px;
            background: linear-gradient(135deg, #3a3028 0%, #2a2018 100%);
            border: 2px solid #5a4a3a;
            border-radius: 6px;
            padding: 8px;
            min-width: 250px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
        }
        
        .midi-device-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .midi-device {
            padding: 8px 12px;
            color: #f5f0e6;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            background: rgba(139, 115, 85, 0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .midi-device:hover {
            background: rgba(139, 115, 85, 0.4);
        }
        
        .midi-device.active {
            background: rgba(255, 215, 0, 0.3);
            color: #ffd700;
        }
        
        #cmaj-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background: rgb(0,0,0);
            background: radial-gradient(circle, #333333ee 0%, #333333cc 100%);
            z-index: 1000;
            text-shadow: 0 0 0.2rem black, 0 0 0.5rem black, 0 0 1rem black, 0 0 3rem black;
            color: white;
            font-family: 'IBM Plex Mono', monospace;
        }
        
        #cmaj-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        
        .synth-container {
            margin: 20px auto 140px auto;
            position: relative;
        }
        
        .cmaj-piano-keyboard {
            width: 100%;
            height: 5rem;
            margin-top: 1rem;
        }
        
        /* Keyboard container styles moved to vintage-keyboard.css */
    </style>
    
    <script src="presets.js"></script>
    <script src="vintage-keyboard.js"></script>
    <script src="vintage-slider.js"></script>
    <script type="module">
        import * as patch from "./cmaj_CINTA.js"
        
        let patchConnection = null;
        let audioContext = null;
        let keyboard = null;
        
        function getMIDIInputEndpointID(connection) {
            console.log('Looking for MIDI input endpoint...');
            console.log('Available input endpoints:', connection.inputEndpoints);
            
            // Look for noteOn endpoint since purpose is undefined
            for (const i of connection.inputEndpoints) {
                if (i.endpointID === "noteOn") {
                    console.log('âœ… Found noteOn endpoint for MIDI input');
                    return i.endpointID;
                }
            }
            console.warn('No noteOn endpoint found!');
            return null;
        }
        
        function createPianoKeyboard(connection) {
            const container = document.getElementById("cmaj-keyboard-container");
            console.log('ðŸŽ¹ Creating vintage keyboard...');
            
            if (container) {
                // Create vintage keyboard with patch connection
                keyboard = new VintageKeyboard(container, connection);
                console.log('âœ… Vintage keyboard created and attached');
                
                // Setup keyboard drawer toggle
                setupKeyboardDrawer();
            } else {
                console.warn('âš ï¸ Cannot create keyboard - container not found');
            }
        }
        
        function setupKeyboardDrawer() {
            const toggleBtn = document.getElementById('keyboardToggleBtn');
            const container = document.getElementById('cmaj-keyboard-container');
            
            // Load saved state from localStorage
            const savedState = localStorage.getItem('cinta-keyboard-open');
            const isOpen = savedState === 'true';
            
            if (isOpen) {
                container.classList.add('open');
                toggleBtn.classList.add('open');
            }
            
            // Toggle button click handler
            toggleBtn.addEventListener('click', () => {
                const isCurrentlyOpen = container.classList.contains('open');
                
                if (isCurrentlyOpen) {
                    container.classList.remove('open');
                    toggleBtn.classList.remove('open');
                    localStorage.setItem('cinta-keyboard-open', 'false');
                    console.log('ðŸŽ¹ Keyboard drawer closed');
                } else {
                    container.classList.add('open');
                    toggleBtn.classList.add('open');
                    localStorage.setItem('cinta-keyboard-open', 'true');
                    console.log('ðŸŽ¹ Keyboard drawer opened');
                }
            });
            
            // Keyboard shortcut: Ctrl+K or Cmd+K
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    toggleBtn.click();
                }
            });
            
            console.log('âœ… Keyboard drawer initialized');
        }
        
        // Computer keyboard is now handled by VintageKeyboard component
        function setupComputerKeyboard() {
            // Add Escape key for panic/all-notes-off
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    console.log('ðŸš¨ PANIC: All Notes Off');
                    for (let note = 0; note < 128; note++) {
                        patchConnection?.sendEventOrValue('noteOff', { pitch: note });
                    }
                    activeNotes.clear();
                }
            });
            
            console.log('âœ… Computer keyboard enabled (A,S,D,F,G,H,J,K,L keys)');
        }
        
        // Test function to manually send a note
        window.testNote = function() {
            if (patchConnection) {
                console.log('ðŸŽµ Testing note C4 (MIDI 60)...');
                console.log('Turning on FM engine...');
                patchConnection.sendEventOrValue('fm_on', 1.0);
                patchConnection.sendEventOrValue('fm_level', 0.8);
                patchConnection.sendEventOrValue('master_volume', 0.8);
                
                setTimeout(() => {
                    console.log('Sending noteOn with format: { pitch, velocity }');
                    try {
                        patchConnection.sendEventOrValue('noteOn', { pitch: 60, velocity: 1.0 });
                        console.log('âœ… NoteOn sent');
                    } catch (e) {
                        console.error('âŒ NoteOn failed:', e);
                    }
                    
                    setTimeout(() => {
                        console.log('Sending noteOff...');
                        try {
                            patchConnection.sendEventOrValue('noteOff', { pitch: 60, velocity: 0.0 });
                            console.log('âœ… NoteOff sent');
                        } catch (e) {
                            console.error('âŒ NoteOff failed:', e);
                        }
                    }, 500);
                }, 100);
            }
        };
        
        // Debug function to check patch status
        window.debugPatch = function() {
            console.log('=== CINTA Debug Info ===');
            console.log('Audio Context:', audioContext);
            console.log('Audio Context State:', audioContext?.state);
            console.log('Patch Connection:', patchConnection);
            console.log('Input Endpoints:', patchConnection?.inputEndpoints);
            console.log('Output Endpoints:', patchConnection?.outputEndpoints);
            console.log('Manifest:', patchConnection?.manifest);
        };
        
        async function loadPatch() {
            audioContext = new AudioContext();
            audioContext.suspend();
            patchConnection = await patch.createAudioWorkletNodePatchConnection(audioContext, "cmaj-worklet-processor");
            
            console.log('Patch connection created:', patchConnection);
            console.log('Audio worklet node:', patchConnection.audioNode);
            
            const startOverlay = document.getElementById("cmaj-overlay");
            const synthContainer = document.getElementById("synth-container");
            
            startOverlay.onclick = async () => {
                console.log('ðŸŽµ Starting CINTA...');
                startOverlay.style.display = "none";
                synthContainer.style.display = "block";
                
                console.log('ðŸ”Œ Connecting audio and MIDI...');
                
                // Request MIDI access explicitly
                try {
                    const midiAccess = await navigator.requestMIDIAccess();
                    console.log('MIDI Access granted:', midiAccess);
                    console.log('MIDI Inputs:', Array.from(midiAccess.inputs.values()).map(i => i.name));
                    
                    // Populate MIDI device list
                    const midiDeviceList = document.getElementById('midiDeviceList');
                    midiDeviceList.innerHTML = '';
                    
                    if (midiAccess.inputs.size === 0) {
                        midiDeviceList.innerHTML = '<div class="midi-device">No MIDI devices connected</div>';
                    } else {
                        for (const input of midiAccess.inputs.values()) {
                            const deviceDiv = document.createElement('div');
                            deviceDiv.className = 'midi-device active';
                            deviceDiv.textContent = `âœ“ ${input.name}`;
                            midiDeviceList.appendChild(deviceDiv);
                        }
                    }
                    
                    // Setup MIDI selector button
                    const midiBtn = document.getElementById('midiSelectorBtn');
                    const midiDropdown = document.getElementById('midiDropdown');
                    midiBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        midiDropdown.style.display = midiDropdown.style.display === 'none' ? 'block' : 'none';
                    });
                    
                    document.addEventListener('click', (e) => {
                        if (!midiDropdown.contains(e.target) && e.target !== midiBtn) {
                            midiDropdown.style.display = 'none';
                        }
                    });
                    
                    // Connect MIDI inputs to the patch
                    for (const input of midiAccess.inputs.values()) {
                        console.log('Connecting MIDI input:', input.name);
                        input.onmidimessage = (message) => {
                            const [status, note, velocity] = message.data;
                            const command = status & 0xF0;
                            
                            if (command === 0x90 && velocity > 0) {
                                // Note On
                                patchConnection.sendEventOrValue('noteOn', { pitch: note, velocity: velocity / 127.0 });
                            } else if (command === 0x80 || (command === 0x90 && velocity === 0)) {
                                // Note Off
                                patchConnection.sendEventOrValue('noteOff', { pitch: note, velocity: 0.0 });
                            }
                        };
                    }
                } catch (e) {
                    console.warn('MIDI access denied or not available:', e);
                }
                
                await patchConnection.connectDefaultAudioAndMIDI(audioContext);
                console.log('Audio outputs:', patchConnection.outputEndpoints);
                
                console.log('â–¶ï¸ Resuming audio context...');
                await audioContext.resume();
                console.log('Audio context state:', audioContext.state);
                console.log('Audio destination:', audioContext.destination);
                
                // Enable FM engine IMMEDIATELY for sound
                console.log('ðŸŽ›ï¸ Enabling FM engine for immediate playback...');
                patchConnection.sendEventOrValue('fm_on', 1.0);
                patchConnection.sendEventOrValue('fm_level', 0.8);
                patchConnection.sendEventOrValue('master_volume', 0.8);
                console.log('âœ… FM engine enabled');
                
                // Verify connection
                setTimeout(() => {
                    console.log('=== Connection Status ===');
                    console.log('Patch connected:', !!patchConnection);
                    console.log('Audio context running:', audioContext.state === 'running');
                    console.log('FM engine: ENABLED');
                }, 1000);
                
                if (patchConnection?.manifest?.isInstrument) {
                    console.log('ðŸŽ¹ Creating piano keyboard...');
                    createPianoKeyboard(patchConnection);
                }
                
                console.log('âŒ¨ï¸ Setting up computer keyboard...');
                setupComputerKeyboard();
                
                console.log('ðŸŽ¨ Initializing vintage UI...');
                initializeVintageUI();
                
                console.log('ðŸŽšï¸ Initializing vintage sliders...');
                initializeVintageSliders();
                
                console.log('âœ… CINTA ready!');
            };
            
            document.getElementById("cmaj-click-to-start").style.opacity = 1.0;
        }
        
        function initializeVintageSliders() {
            // FM Engine sliders - brass/gold
            createSliderGroup(document.getElementById('fm-sliders'), [
                { param: 'fm_ratio', label: 'RATIO', min: 0.5, max: 16, value: 2, unit: '', color: 'gold', decimals: 1 },
                { param: 'fm_depth', label: 'DEPTH', min: 0, max: 1, value: 0.5, unit: '', color: 'gold', decimals: 2 },
                { param: 'fm_feedback', label: 'FEEDBACK', min: 0, max: 1, value: 0, unit: '', color: 'gold', decimals: 2 },
                { param: 'fm_level', label: 'LEVEL', min: 0, max: 1, value: 0.7, unit: '', color: 'gold', decimals: 2 }
            ], patchConnection);
            
            // Tape Engine sliders - brass/gold
            createSliderGroup(document.getElementById('tape-sliders'), [
                { param: 'tape_wow', label: 'WOW', min: 0, max: 1, value: 0.2, unit: '', color: 'gold', decimals: 2 },
                { param: 'tape_flutter', label: 'FLUTTER', min: 0, max: 1, value: 0.1, unit: '', color: 'gold', decimals: 2 },
                { param: 'tape_level', label: 'LEVEL', min: 0, max: 1, value: 0.7, unit: '', color: 'gold', decimals: 2 }
            ], patchConnection);
            
            // Analog Engine sliders - brass/gold
            createSliderGroup(document.getElementById('analog-sliders'), [
                { param: 'analog_detune', label: 'DETUNE', min: -100, max: 100, value: 5, unit: '', color: 'gold', decimals: 0 },
                { param: 'analog_filter_cutoff', label: 'CUTOFF', min: 20, max: 20000, value: 8000, unit: 'Hz', color: 'gold', decimals: 0 },
                { param: 'analog_filter_reso', label: 'RESO', min: 0, max: 1, value: 0.2, unit: '', color: 'gold', decimals: 2 },
                { param: 'analog_level', label: 'LEVEL', min: 0, max: 1, value: 0.7, unit: '', color: 'gold', decimals: 2 }
            ], patchConnection);
            
            // Envelope sliders (ADSR) - brass/gold
            createSliderGroup(document.getElementById('envelope-sliders'), [
                { param: 'amp_attack', label: 'ATTACK', min: 0.001, max: 5, value: 0.01, unit: 's', color: 'gold', decimals: 3 },
                { param: 'amp_decay', label: 'DECAY', min: 0.001, max: 5, value: 0.2, unit: 's', color: 'gold', decimals: 2 },
                { param: 'amp_sustain', label: 'SUSTAIN', min: 0, max: 1, value: 0.7, unit: '', color: 'gold', decimals: 2 },
                { param: 'amp_release', label: 'RELEASE', min: 0.001, max: 5, value: 0.3, unit: 's', color: 'gold', decimals: 2 }
            ], patchConnection);
            
            // Master volume slider - brass/gold
            createSliderGroup(document.getElementById('master-slider'), [
                { param: 'master_volume', label: 'MASTER', min: 0, max: 1, value: 0.8, unit: '', color: 'gold', decimals: 2 }
            ], patchConnection);
            
            console.log('âœ… Vintage sliders initialized for FM, Tape, Analog, Envelope, and Master (brass/gold aesthetic)');
        }
        
        function initializeVintageUI() {
            window.patchConnection = patchConnection;
            
            const sizeManagerScript = document.createElement('script');
            sizeManagerScript.src = 'size-manager.js';
            sizeManagerScript.onload = () => {
                // Manually trigger size manager initialization since DOMContentLoaded already fired
                if (typeof SizeManager !== 'undefined') {
                    window.cintaSizeManager = new SizeManager();
                    console.log('âœ… Size Manager initialized');
                }
            };
            document.body.appendChild(sizeManagerScript);
            
            const mainVintageScript = document.createElement('script');
            mainVintageScript.src = 'main-vintage.js';
            document.body.appendChild(mainVintageScript);
        }
        
        loadPatch();
    </script>
</body>
</html>
